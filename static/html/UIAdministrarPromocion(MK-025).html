<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Promociones - QuickContentMedia</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <div class="side-bar">
            <div class="name">QCM</div>
            <div class="side-bar-options">
                <a href="/admin"><i class="fa-solid fa-house"></i><span>Inicio</span></a>
            </div>
            <div class="side-bar-options active">
                <a href="/admin/promociones"><i class="fa-solid fa-tags"></i><span>Administrar Promociones</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/contenidos"><i class="fa-solid fa-plus"></i><span>Administrar Contenido</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/categorias"><i class="fa-solid fa-layer-group"></i><span>Administrar Categoría</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/clientes"><i class="fa-solid fa-users"></i><span>Administrar Clientes</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/logout" id="logout-link"><i class="fa-solid fa-right-from-bracket"></i><span>Cerrar Sesión</span></a>
            </div>
        </div>
        <!-- Sección de Administrar Promociones -->
        <div class="main-content" id="promocionesSection">
            <div class="content-wrapper">
            <h2 class="small-title">Promociones</h2>
            <div class="content-header">
                <button type="button" class="button-full" id="small-btn" onclick="openModal('agregarPromocionModal')">Agregar Promoción</button>
                <div class="search-container">
                    <input type="text" id="search-promocion" class="search-input" placeholder="Buscar promoción...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>

            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Porcentaje</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="promocionesTableBody">
                        <!-- Contenido tabla -->
                    </tbody>
                    <div class="pagination" id="promocionesPagination"></div>
                </table>
                </div>
            </div>
        </div>

        <!-- Modal Agregar Promoción -->
        <div id="agregarPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('agregarPromocionModal')">&times;</span>
                <h2 class="small-title">Agregar Promoción</h2>
                <form id="agregarPromocionForm">
                    <div class="modal-grid">
                        <div class="left-grid">
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="text" name="nombre" placeholder="Nombre de la promoción" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="number" step="0.01" name="porcentaje" placeholder="Porcentaje de descuento" min="1" max="100" required>
                            </div>
                        </div>
                        <div class="right-grid">
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" name="fecha_inicio" placeholder="Fecha de inicio" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" name="fecha_fin" placeholder="Fecha de fin" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-plus edit-icon"></i>
                                <input type="text" id="codigoContenido" placeholder="Código del contenido">
                                <button type="button" class="button-full-gray" onclick="agregarContenidoAPromocion()">Agregar</button>
                            </div>
                            <div class="table">
                                <table id="tablaContenidosPromocion">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Formato</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contenidosPromocionBody">
                                        <!-- Contenidos agregados a la promoción -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="submit" class="button-full">Confirmar Promoción</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Editar Promoción -->
        <div id="editarPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('editarPromocionModal')">&times;</span>
                <h2 class="small-title">Editar Promoción</h2>
                <form id="editarPromocionForm">
                    <input type="hidden" id="editPromocionId" name="promocion_id">
                    <div class="modal-grid">
                        <div class="left-grid">
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="text" id="editNombrePromocion" name="nombre" placeholder="Nombre de la promoción" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="number" step="0.01" id="editPorcentaje" name="porcentaje" placeholder="Porcentaje de descuento" min="1" max="100" required>
                            </div>
                        </div>
                        <div class="right-grid">
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" id="editFechaInicio" name="fecha_inicio" placeholder="Fecha de inicio" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" id="editFechaFin" name="fecha_fin" placeholder="Fecha de fin" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-plus edit-icon"></i>
                                <input type="text" id="editCodigoContenido" placeholder="Código del contenido">
                                <button type="button" class="button-full-gray" onclick="agregarContenidoAEdicion()">Agregar</button>
                            </div>
                            <div class="table">
                                <table id="editTablaContenidosPromocion">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Formato</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editContenidosPromocionBody">
                                        <!-- Contenidos agregados a la promoción -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="submit" class="button-full">Guardar Cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Eliminar Promoción -->
        <div id="eliminarPromocionModal" class="modal">
            <form class="form" id="eliminarPromocionForm">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('eliminarPromocionModal')">&times;</span>
                    <h2 class="form-title">¿Está seguro de que deseas eliminar esta promoción?</h2>
                    <input type="hidden" id="promocionIdEliminar" name="promocion_id">
                    <p class="form-subtitle">Esta acción es permanente y no se puede deshacer.</p>
                    <button type="submit" class="button-full deletebtn">Eliminar Promoción</button>
                </div>
            </form>
        </div>

        <!-- Modal Ver Contenidos de Promoción -->
        <div id="verContenidosPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('verContenidosPromocionModal')">&times;</span>
                <h2 class="small-title">Contenidos incluidos en la promoción</h2>
                <div class="table">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Código</th>
                                <th>Formato</th>
                                <th>Precio Original</th>
                                <th>Precio con Descuento</th>
                            </tr>
                        </thead>
                        <tbody id="contenidosPromocionModalBody">
                            <!-- Contenidos de la promoción -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Funciones JavaScript relacionadas -->
        <script>
            // Función para paginar tabla
            function paginarTabla(tablaSelector, paginationSelector) {
                const tabla = document.querySelector(tablaSelector);
                const tbody = tabla.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const pagination = document.querySelector(paginationSelector);

                if (!rows.length) {
                    pagination.innerHTML = '';
                    return;
                }

                const itemsPerPage = 10;
                const totalPages = Math.ceil(rows.length / itemsPerPage);

                // Crear botones de paginación
                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.onclick = () => mostrarPagina(i);
                    pagination.appendChild(button);
                }

                function mostrarPagina(pageNumber) {
                    const start = (pageNumber - 1) * itemsPerPage;
                    const end = start + itemsPerPage;

                    rows.forEach((row, index) => {
                        row.style.display = (index >= start && index < end) ? '' : 'none';
                    });

                    // Resaltar el botón de la página actual
                    const buttons = pagination.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.className = '';
                        if (parseInt(button.textContent) === pageNumber) {
                            button.className = 'active';
                        }
                    });
                }

                // Mostrar la primera página
                mostrarPagina(1);
            }

            // Función para cargar promociones
            function cargarPromociones() {
                fetch('/api/obtener_promociones', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al obtener promociones: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Datos recibidos de promociones:', data);
                        if (data.success) {
                            const tbody = document.getElementById("promocionesTableBody");
                            tbody.innerHTML = '';

                            // Verificar si data.data existe y es un array, si no, usar array vacío
                            const promociones = Array.isArray(data.data) ? data.data : [];
                            console.log('Promociones a mostrar:', promociones);

                            promociones.forEach(promocion => {
                                const tr = document.createElement("tr");
                                tr.innerHTML =
                                    `<td><strong>${promocion.nombre}</strong></td>
                                    <td>${new Date(promocion.fecha_inicio).toLocaleDateString()}</td>
                                    <td>${new Date(promocion.fecha_fin).toLocaleDateString()}</td>
                                    <td>${promocion.porcentaje}%</td>
                                    <td>
                                        <button onclick="openEditModal(${promocion.id})">Editar</button>
                                        <button onclick="openVerContenidosModal(${promocion.id})">Ver Contenidos</button>
                                        <button onclick="openDeleteModal(${promocion.id})">Eliminar</button>
                                    </td>`;
                                tbody.appendChild(tr);
                            });

                            // Agregar estilo para el botón activo de paginación
                            const pagination = document.getElementById('promocionesPagination');
                            pagination.innerHTML += `
                                <style>
                                    /* Estilos para el modal */
                                    .modal {
                                        display: none;
                                        position: fixed;
                                        z-index: 1000;
                                        left: 0;
                                        top: 0;
                                        width: 100%;
                                        height: 100%;
                                        overflow: auto;
                                        background-color: rgba(0,0,0,0.4);
                                    }

                                    .modal-content {
                                        background-color: #fff;
                                        margin: 10% auto;
                                        padding: 20px;
                                        border-radius: 8px;
                                        width: 70%;
                                        max-width: 800px;
                                        position: relative;
                                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                                    }

                                    .modal .close {
                                        position: absolute;
                                        right: 20px;
                                        top: 10px;
                                        font-size: 28px;
                                        font-weight: bold;
                                        cursor: pointer;
                                    }

                                    .modal .table-container {
                                        margin-top: 20px;
                                        flex: 1;
                                        overflow: auto;
                                        width: 100%;
                                    }

                                    .modal .table {
                                        width: 100%;
                                        border-collapse: collapse;
                                        table-layout: fixed;
                                    }

                                    .modal .table th,
                                    .modal .table td {
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        word-wrap: break-word;
                                        min-width: 100px;
                                    }

                                    .modal .table th {
                                        background-color: #f5f5f5;
                                        font-weight: 600;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                    }

                                    .modal .table tr:hover {
                                        background-color: #f9f9f9;
                                    }
                                    
                                    /* Asegurar que el modal tenga un tamaño adecuado */
                                    .modal-content {
                                        display: flex;
                                        flex-direction: column;
                                        max-height: 80vh;
                                        min-height: 300px;
                                        width: 90%;
                                        max-width: 1000px;
                                    }
                                    
                                    /* Asegurar que la tabla sea desplazable */
                                    .modal .table-wrapper {
                                        flex: 1;
                                        overflow: auto;
                                        width: 100%;
                                    }
                                    
                                    /* Estilo para el mensaje cuando no hay contenidos */
                                    .no-results {
                                        text-align: center;
                                        padding: 20px;
                                        color: #666;
                                        font-style: italic;
                                        grid-column: 1 / -1;
                                    }

                                    .no-results {
                                        text-align: center;
                                        padding: 20px;
                                        color: #666;
                                        font-style: italic;
                                    }

                                    /* Estilos generales */
                                    * {
                                        box-sizing: border-box;
                                    }

                                    .pagination button {
                                        margin: 2px;
                                        padding: 5px 10px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        cursor: pointer;
                                    }
                                    .pagination button.active {
                                        background-color: #007bff;
                                        color: white;
                                        border-color: #007bff;
                                    }
                                    .pagination button:hover:not(.active) {
                                        background-color: #e9ecef;
                                    }
                                </style>
                            `;

                            paginarTabla('.table', '#promocionesPagination');
                        } else {
                            console.error('Error en la respuesta:', data);
                            alert(data.error || 'Error al cargar las promociones');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al conectar con el servidor: ' + error.message);
                    });
            }

            // Función para formatear fecha (solo fecha, sin hora)
            function formatearFecha(fechaString) {
                if (!fechaString) return '';
                
                // Crear la fecha ajustando por la zona horaria
                // Añadimos 'T00:00:00' para evitar problemas de zona horaria
                const fecha = new Date(fechaString + 'T00:00:00');
                
                // Si la fecha no es válida, devolver un valor por defecto
                if (isNaN(fecha.getTime())) return 'Fecha inválida';
                
                // Obtener los componentes de la fecha local
                // Usamos getUTCDate() para evitar problemas de zona horaria
                const dia = fecha.getUTCDate().toString().padStart(2, '0');
                const mes = (fecha.getUTCMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getUTCFullYear();
                
                return `${dia}/${mes}/${anio}`;
            }

            // Función para formatear fecha al formato YYYY-MM-DD (sin hora)
            function formatearFechaParaInput(fechaString) {
                if (!fechaString) return '';

                // Si ya está en el formato YYYY-MM-DD, devolverlo tal cual
                if (/^\d{4}-\d{2}-\d{2}$/.test(fechaString)) {
                    return fechaString;
                }


                try {
                    // Intentar crear una fecha a partir del string
                    const fecha = new Date(fechaString);
                    if (isNaN(fecha.getTime())) {
                        console.error('Fecha inválida:', fechaString);
                        return '';
                    }

                    // Formatear como YYYY-MM-DD
                    const year = fecha.getFullYear();
                    const month = (fecha.getMonth() + 1).toString().padStart(2, '0');
                    const day = fecha.getDate().toString().padStart(2, '0');
                    
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error('Error al formatear fecha:', e);
                    return '';
                }
            }

            // Función para abrir modal de edición con datos de la promoción
            function openEditarPromocionModal(id, nombre, porcentaje, fechaInicio, fechaFin) {
                document.getElementById('editPromocionId').value = id;
                document.getElementById('editNombrePromocion').value = nombre;
                document.getElementById('editPorcentaje').value = porcentaje;
                
                // Formatear fechas para el input type="date"
                const fechaInicioObj = new Date(fechaInicio);
                const fechaFinObj = new Date(fechaFin);
                
                // Formatear a YYYY-MM-DD
                const formatDate = (date) => {
                    const d = new Date(date);
                    let month = '' + (d.getMonth() + 1);
                    let day = '' + d.getDate();
                    const year = d.getFullYear();

                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                };
                
                document.getElementById('editFechaInicio').value = formatDate(fechaInicioObj);
                document.getElementById('editFechaFin').value = formatDate(fechaFinObj);
                
                // Limpiar tabla de contenidos
                const tbody = document.getElementById('editContenidosPromocionBody');
                tbody.innerHTML = '';
                
                // Cargar contenidos de la promoción
                fetch(`/api/promociones/${id}/contenidos`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.contenidos && data.contenidos.length > 0) {
                            data.contenidos.forEach(contenido => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${contenido.nombre || 'Sin nombre'}</td>
                                    <td>${contenido.id_contenido || 'N/A'}</td>
                                    <td>${contenido.formato || 'N/A'}</td>
                                    <td>
                                        <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <input type="hidden" name="contenidos[]" value="${contenido.id_contenido}">
                                    </td>`;
                                tbody.appendChild(tr);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar contenidos:', error);
                    });
                
                openModal('editarPromocionModal');
            }

            function prepararEliminarPromocion(promocionId) {
                if (confirm('¿Está seguro de que desea eliminar esta promoción? Esta acción no se puede deshacer.')) {
                    eliminarPromocion(promocionId);
                }
            }

            async function eliminarPromocion(promocionId) {
                try {
                    const response = await fetch('/api/promociones/eliminar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ promocion_id: promocionId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Promoción eliminada correctamente');
                        cargarPromociones(); // Recargar la lista de promociones
                    } else {
                        throw new Error(data.error || 'Error al eliminar la promoción');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar la promoción: ' + error.message);
                }
            }

            // Función para ver contenidos de una promoción
            function openVerContenidosModal(promocionId) {
                const modal = document.getElementById('verContenidosPromocionModal');
                const tbody = document.getElementById('contenidosPromocionModalBody');

                if (!modal || !tbody) {
                    console.error('Modal o Tbody no encontrados');
                    return;
                }

                tbody.innerHTML = ''; // Limpiar contenido anterior

                fetch(`/api/promociones/${promocionId}/contenidos`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const { contenidos, promocion } = data;

                            if (contenidos.length === 0) {
                                const row = tbody.insertRow();
                                const cell = row.insertCell();
                                cell.colSpan = 5;
                                cell.textContent = 'No hay contenidos asociados a esta promoción.';
                                cell.style.textAlign = 'center';
                            } else {
                                const porcentajeDescuento = promocion.porcentaje;
                                contenidos.forEach(contenido => {
                                    const precioOriginal = contenido.precio;
                                    const precioConDescuento = precioOriginal * (1 - porcentajeDescuento / 100);
                                    const row = tbody.insertRow();
                                    row.insertCell().textContent = contenido.nombre;
                                    row.insertCell().textContent = contenido.codigo;
                                    row.insertCell().textContent = contenido.formato;
                                    row.insertCell().textContent = `S/ ${precioOriginal.toFixed(2)}`;
                                    row.insertCell().textContent = `S/ ${precioConDescuento.toFixed(2)}`;
                                });
                            }
                            modal.style.display = 'block';
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar contenidos de la promoción:', error);
                        alert('Error al conectar con el servidor.');
                    });
            }

            // Función para agregar contenido a promoción nueva
            function agregarContenidoAPromocion() {
                const codigo = document.getElementById("codigoContenido").value.trim();
                if (!codigo) return;

                fetch(`/api/contenido?id=${codigo}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Contenido no encontrado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.contenido) {
                            const contenido = data.contenido;
                            const tbody = document.getElementById("contenidosPromocionBody");

                            // Verificar si el contenido ya está agregado
                            const existente = Array.from(tbody.querySelectorAll("tr")).some(tr => {
                                const codigoCelda = tr.querySelector("td:nth-child(2)").textContent;
                                return codigoCelda === (contenido.codigo || '');
                            });

                            if (existente) {
                                alert("Este contenido ya está incluido en la promoción");
                                return;
                            }

                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                `<td>${contenido.nombre || 'Sin nombre'}</td>
                                <td>${contenido.codigo || 'N/A'}</td>
                                <td>${contenido.formato || 'N/A'}</td>
                                <td>
                                    <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <input type="hidden" name="contenidos[]" value="${contenido.id_contenido || ''}">
                                </td>`;
                            tbody.appendChild(tr);
                            document.getElementById("codigoContenido").value = '';
                        } else {
                            throw new Error(data.error || 'No se encontró contenido con ese ID');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + (error.message || 'No se pudo encontrar el contenido'));
                    });
            }

            // Función para agregar contenido a promoción en edición
            function agregarContenidoAEdicion() {
                const codigo = document.getElementById("editCodigoContenido").value.trim();
                if (!codigo) return;

                fetch(`/api/contenido?id=${codigo}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Contenido no encontrado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.contenido) {
                            const contenido = data.contenido;
                            const tbody = document.getElementById("editContenidosPromocionBody");

                            // Verificar si el contenido ya está agregado
                            const existente = Array.from(tbody.querySelectorAll("tr")).some(tr => {
                                const idContenido = tr.querySelector("input[type='hidden']").value;
                                return idContenido === (contenido.id_contenido || '');
                            });

                            if (existente) {
                                alert("Este contenido ya está incluido en la promoción");
                                return;
                            }

                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                `<td>${contenido.nombre || 'Sin nombre'}</td>
                                <td>${contenido.id_contenido || 'N/A'}</td>
                                <td>${contenido.formato || 'N/A'}</td>
                                <td>
                                    <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <input type="hidden" name="contenidos[]" value="${contenido.id_contenido || ''}">
                                </td>`;
                            tbody.appendChild(tr);
                            document.getElementById("editCodigoContenido").value = '';
                        } else {
                            throw new Error(data.error || 'No se encontró contenido con ese ID');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + (error.message || 'No se pudo encontrar el contenido'));
                    });
            }

            // Función para eliminar contenido de la tabla
            function eliminarContenidoDeTabla(button) {
                const tr = button.closest("tr");
                tr.remove();
            }

            // Búsqueda de promociones
            const searchPromocionInput = document.getElementById('search-promocion');
            searchPromocionInput.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const rows = document.querySelectorAll('#promocionesTableBody tr');

                rows.forEach(fila => {
                    const nombrePromocion = fila.querySelector("td strong").textContent.toLowerCase();

                    if (nombrePromocion.includes(filtro)) {
                        fila.style.display = "";
                    } else {
                        fila.style.display = "none";
                    }
                });
            });

            // Manejo de formulario agregar promoción
            document.getElementById("agregarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                // Obtener IDs de contenidos de la tabla
                const contenidos = [];
                const filasContenidos = document.querySelectorAll('#contenidosPromocionBody tr');
                filasContenidos.forEach(fila => {
                    const idContenido = fila.querySelector('input[type="hidden"]').value;
                    if (idContenido) {
                        contenidos.push(idContenido);
                    }
                });
                
                // Agregar contenidos al formData
                contenidos.forEach((id, index) => {
                    formData.append('contenidos[]', id);
                });

                try {
                    // Convert FormData to JSON object
                    const formDataObj = {};
                    formData.forEach((value, key) => {
                        if (key === 'contenidos[]') {
                            if (!formDataObj['contenidos']) {
                                formDataObj['contenidos'] = [];
                            }
                            formDataObj['contenidos'].push(value);
                        } else {
                            formDataObj[key] = value;
                        }
                    });

                    // Log the data being sent
                    console.log('Sending data to server:', JSON.stringify(formDataObj, null, 2));
                    
                    try {
                        const response = await fetch('/api/promociones', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formDataObj)
                        });
                        
                        console.log('Response status:', response.status);
                        const responseText = await response.text();
                        console.log('Response text:', responseText);
                        
                        if (!response.ok) {
                            let errorMessage = 'Error al procesar la solicitud';
                            try {
                                const errorData = JSON.parse(responseText);
                                errorMessage = errorData.error || JSON.stringify(errorData);
                            } catch (e) {
                                errorMessage = responseText || errorMessage;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const data = responseText ? JSON.parse(responseText) : {};
                        
                        if (data.success) {
                            alert('Promoción agregada correctamente');
                            closeModal('agregarPromocionModal');
                            cargarPromociones();
                        } else {
                            throw new Error(data.error || 'Error al agregar la promoción');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert(error.message || 'Error al conectar con el servidor');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                }
            });

            // Manejo de formulario editar promoción
            document.getElementById("editarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();

                const promocionId = document.getElementById("editPromocionId").value;
                const formData = new FormData(this);

                // Obtener todos los contenidos de la tabla
                const contenidos = [];
                document.querySelectorAll('#editContenidosPromocionBody tr').forEach(row => {
                    const input = row.querySelector('input[type="hidden"][name="contenidos[]"]');
                    if (input && input.value) {
                        contenidos.push(input.value);
                    }
                });

                // Agregar cada contenido individualmente al FormData
                contenidos.forEach(contenidoId => {
                    formData.append('contenidos[]', contenidoId);
                });

                try {
                    const response = await fetch(`/api/promociones/${promocionId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Error al actualizar la promoción');
                    }

                    if (result.success) {
                        alert('Promoción actualizada correctamente');
                        closeModal('editarPromocionModal');
                        cargarPromociones();
                    } else {
                        throw new Error(result.error || 'Error al actualizar la promoción');
                    }
                } catch (error) {
                    console.error('Error al actualizar promoción:', error);
                    alert(`Error: ${error.message}`);
                }
            });

            // Manejo de formulario eliminar promoción
            document.getElementById("eliminarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                try {
                    const response = await fetch('/eliminar_promocion', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Promoción eliminada correctamente');
                        closeModal('eliminarPromocionModal');
                        cargarPromociones();
                    } else {
                        alert(data.error || 'Error al eliminar la promoción');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                }
            });

            // Función para abrir modal
            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "block";
                    // Agregar el overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.onclick = () => closeModal(modalId);
                    document.body.appendChild(overlay);
                    
                    // Solo limpiar el formulario si no es el modal de edición
                    if (!modalId.includes('editar')) {
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                            // Limpiar la tabla de contenidos
                            const tablaContenidos = modal.querySelector('#contenidosPromocionBody');
                            if (tablaContenidos) {
                                tablaContenidos.innerHTML = '';
                            }
                        }
                    }
                }
            }

            // Función para cerrar modal
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "none";
                    // Remover el overlay
                    const overlay = document.querySelector('.modal-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }
            }

            // Cargar promociones al iniciar
            document.addEventListener('DOMContentLoaded', function() {
                cargarPromociones();
            });
        </script>
    </div>
</div>

<!-- Modal para ver contenidos de promoción -->
<div id="verContenidosPromocionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('verContenidosPromocionModal')">&times;</span>
        <h2 class="small-title">Contenidos de la Promoción: <span id="nombrePromocion"></span></h2>
        <div class="table-wrapper">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Nombre</th>
                            <th style="width: 15%;">Código</th>
                            <th style="width: 15%;">Formato</th>
                            <th style="width: 20%;">Precio Original</th>
                            <th style="width: 25%;">Precio con Descuento</th>
                        </tr>
                    </thead>
                    <tbody id="contenidosPromocionBody">
                        <!-- Los contenidos se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="button-full" onclick="closeModal('verContenidosPromocionModal')">Cerrar</button>
        </div>
    </div>
</div>

<script>
    // Función para abrir el modal de ver contenidos
    async function verContenidosPromocion(promocionId, nombrePromocion) {
        console.log('Ver contenidos para promoción ID:', promocionId, 'Nombre:', nombrePromocion);
        
        try {
            // Actualizar el título de la promoción en el modal
            const tituloPromocion = document.getElementById('nombrePromocion');
            if (tituloPromocion) {
                tituloPromocion.textContent = nombrePromocion;
            } else {
                console.error('No se encontró el elemento con ID nombrePromocion');
            }
            
            // Obtener referencia a la tabla
            const tbody = document.getElementById('contenidosPromocionBody');
            if (!tbody) {
                console.error('No se encontró el elemento tbody con ID contenidosPromocionBody');
                return;
            }
            
            // Mostrar mensaje de carga
            tbody.innerHTML = '<tr><td colspan="3" class="no-results">Cargando contenidos...</td></tr>';
            
            // Abrir el modal
            const modal = document.getElementById('verContenidosPromocionModal');
            if (modal) {
                console.log('Mostrando modal de contenidos');
                modal.style.display = 'block';
                modal.classList.add('show');
                
                // Agregar overlay
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                document.body.appendChild(overlay);
                
                // Cerrar al hacer clic fuera del modal
                overlay.onclick = function() {
                    closeModal('verContenidosPromocionModal');
                };
            } else {
                console.error('No se encontró el modal con ID verContenidosPromocionModal');
                return;
            }
            
            try {
                console.log('Haciendo petición a:', `/api/promociones/${promocionId}/contenidos`);
                // Hacer la petición para obtener los contenidos
                const response = await fetch(`/api/promociones/${promocionId}/contenidos`);
                
                if (!response.ok) {
                    throw new Error(`Error en la petición: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Respuesta de la API:', result);
                
                // Procesar la respuesta
                const responseData = result.data || result; // Manejar tanto result.data como respuesta directa
                const contenidos = Array.isArray(responseData.contenidos) ? responseData.contenidos : [];
                
                console.log('Datos de respuesta procesados:', responseData);
                console.log('Número de contenidos encontrados:', contenidos.length);
                console.log('Contenidos:', contenidos);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Limpiar la tabla
                tbody.innerHTML = '';
                
                if (contenidos.length === 0) {
                    console.log('No se encontraron contenidos para esta promoción');
                    tbody.innerHTML = '<tr><td colspan="3" class="no-results">No hay contenidos asociados a esta promoción.</td></tr>';
                } else {
                    console.log('Agregando contenidos a la tabla...');
                    // Agregar cada contenido a la tabla
                    contenidos.forEach((contenido, index) => {
                        console.log(`Procesando contenido ${index + 1}:`, contenido);
                        if (contenido) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${contenido.nombre || 'Sin nombre'}</td>
                                <td>${contenido.codigo || contenido.id_contenido || 'N/A'}</td>
                                <td>${contenido.formato || 'N/A'}</td>
                                <td>${contenido.precio ? `$${parseFloat(contenido.precio).toFixed(2)}` : 'N/A'}</td>
                                <td>${contenido.precio && responseData.promocion?.porcentaje 
                                    ? `$${(parseFloat(contenido.precio) * (1 - parseFloat(responseData.promocion.porcentaje) / 100)).toFixed(2)}` 
                                    : 'N/A'}</td>
                            `;
                            console.log('Fila HTML creada:', tr.outerHTML);
                            tbody.appendChild(tr);
                        }
                    });
                    console.log('Contenidos agregados a la tabla');
                }
            } catch (error) {
                console.warn('Error al cargar contenidos:', error);
                tbody.innerHTML = `<tr><td colspan="3" class="no-results">Error al cargar los contenidos: ${error.message || 'Error desconocido'}</td></tr>`;
            }
        } catch (error) {
            console.error('Error al cargar contenidos:', error);
            const tbody = document.getElementById('contenidosPromocionBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="3" class="no-results">No se pudieron cargar los contenidos. Intente nuevamente.</td></tr>';
            }
        }
    }

    // Cargar promociones al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        cargarPromociones();
    });
</script>
</body>
</html>