<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Promociones - QuickContentMedia</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <div class="side-bar">
            <div class="name">QCM</div>
            <div class="side-bar-options">
                <a href="/admin"><i class="fa-solid fa-house"></i><span>Inicio</span></a>
            </div>
            <div class="side-bar-options active">
                <a href="/admin/promociones"><i class="fa-solid fa-tags"></i><span>Administrar Promociones</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/contenidos"><i class="fa-solid fa-plus"></i><span>Administrar Contenido</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/categorias"><i class="fa-solid fa-layer-group"></i><span>Administrar Categoría</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/admin/clientes"><i class="fa-solid fa-users"></i><span>Administrar Clientes</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/logout" id="logout-link"><i class="fa-solid fa-right-from-bracket"></i><span>Cerrar Sesión</span></a>
            </div>
        </div>
        <!-- Sección de Administrar Promociones -->
        <div class="main-content" id="promocionesSection">
            <div class="content-wrapper">
            <h2 class="small-title">Promociones</h2>
            <div class="content-header">
                <button type="button" class="button-full" id="small-btn" onclick="openModal('agregarPromocionModal')">Agregar Promoción</button>
                <div class="search-container">
                    <input type="text" id="search-promocion" class="search-input" placeholder="Buscar promoción...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>

            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Porcentaje</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="promocionesTableBody">
                        <!-- Contenido tabla -->
                    </tbody>
                    <div class="pagination" id="promocionesPagination"></div>
                </table>
                </div>
            </div>
        </div>

        <!-- Modal Agregar Promoción -->
        <div id="agregarPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('agregarPromocionModal')">&times;</span>
                <h2 class="small-title">Agregar Promoción</h2>
                <form id="agregarPromocionForm">
                    <div class="modal-grid">
                        <div class="left-grid">
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="text" name="nombre" placeholder="Nombre de la promoción" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="number" step="0.01" name="porcentaje" placeholder="Porcentaje de descuento" min="1" max="100" required>
                            </div>
                        </div>
                        <div class="right-grid">
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" name="fecha_inicio" placeholder="Fecha de inicio" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" name="fecha_fin" placeholder="Fecha de fin" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-plus edit-icon"></i>
                                <input type="text" id="codigoContenido" placeholder="Código del contenido">
                                <button type="button" class="button-full-gray" onclick="agregarContenidoAPromocion()">Agregar</button>
                            </div>
                            <div class="table">
                                <table id="tablaContenidosPromocion">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Formato</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contenidosPromocionBody">
                                        <!-- Los contenidos se cargarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="submit" class="button-full">Confirmar Promoción</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Editar Promoción -->
        <div id="editarPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('editarPromocionModal')">&times;</span>
                <h2 class="small-title">Editar Promoción</h2>
                <form id="editarPromocionForm">
                    <input type="hidden" id="editPromocionId" name="promocion_id">
                    <div class="modal-grid">
                        <div class="left-grid">
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="text" id="editNombrePromocion" name="nombre" placeholder="Nombre de la promoción" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-pen edit-icon"></i>
                                <input type="number" step="0.01" id="editPorcentaje" name="porcentaje" placeholder="Porcentaje de descuento" min="1" max="100" required>
                            </div>
                        </div>
                        <div class="right-grid">
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" id="editFechaInicio" name="fecha_inicio" placeholder="Fecha de inicio" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-calendar edit-icon"></i>
                                <input type="date" id="editFechaFin" name="fecha_fin" placeholder="Fecha de fin" required>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-plus edit-icon"></i>
                                <input type="text" id="editCodigoContenido" placeholder="Código del contenido">
                                <button type="button" class="button-full-gray" onclick="agregarContenidoAEdicion()">Agregar</button>
                            </div>
                            <div class="table">
                                <table id="editTablaContenidosPromocion">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Formato</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editContenidosPromocionBody">
                                        <!-- Contenidos agregados a la promoción -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="submit" class="button-full">Guardar Cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Eliminar Promoción -->
        <div id="eliminarPromocionModal" class="modal">
            <form class="form" id="eliminarPromocionForm">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('eliminarPromocionModal')">&times;</span>
                    <h2 class="form-title">¿Está seguro de que deseas eliminar esta promoción?</h2>
                    <input type="hidden" id="promocionIdEliminar" name="promocion_id">
                    <p class="form-subtitle">Esta acción es permanente y no se puede deshacer.</p>
                    <button type="submit" class="button-full deletebtn">Eliminar Promoción</button>
                </div>
            </form>
        </div>

        <!-- Modal Ver Contenidos de Promoción -->
        <div id="verContenidosPromocionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('verContenidosPromocionModal')">&times;</span>
                <h2 class="small-title">Contenidos de la Promoción: <span id="nombrePromocion"></span></h2>
                <div class="table-wrapper">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Nombre</th>
                                    <th style="width: 15%;">Código</th>
                                    <th style="width: 15%;">Formato</th>
                                    <th style="width: 20%;">Precio Original</th>
                                    <th style="width: 25%;">Precio con Descuento</th>
                                </tr>
                            </thead>
                            <tbody id="contenidosPromocionBody">
                                <!-- Los contenidos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button-full" onclick="closeModal('verContenidosPromocionModal')">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- NUEVO Modal para ver contenidos de promoción (FUNCIONAL) -->
        <div id="modalContenidosNuevo" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: white; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                <span style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('modalContenidosNuevo').style.display='none'">&times;</span>
                <h2>Contenidos de la Promoción: <span id="nombrePromocionNuevo"></span></h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 25%;">Nombre</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 15%;">Código</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 15%;">Formato</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 20%;">Precio Original</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 25%;">Precio con Descuento</th>
                        </tr>
                    </thead>
                    <tbody id="contenidosPromocionBodyNuevo">
                        <!-- Los contenidos se cargarán aquí -->
                    </tbody>
                </table>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="document.getElementById('modalContenidosNuevo').style.display='none'" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Funciones JavaScript relacionadas -->
        <script>
            // Función para paginar tabla
            function paginarTabla(tablaSelector, paginationSelector) {
                const tabla = document.querySelector(tablaSelector);
                const tbody = tabla.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const pagination = document.querySelector(paginationSelector);

                if (!rows.length) {
                    pagination.innerHTML = '';
                    return;
                }

                const itemsPerPage = 10;
                const totalPages = Math.ceil(rows.length / itemsPerPage);

                // Crear botones de paginación
                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.onclick = () => mostrarPagina(i);
                    pagination.appendChild(button);
                }

                function mostrarPagina(pageNumber) {
                    const start = (pageNumber - 1) * itemsPerPage;
                    const end = start + itemsPerPage;

                    rows.forEach((row, index) => {
                        row.style.display = (index >= start && index < end) ? '' : 'none';
                    });

                    // Resaltar el botón de la página actual
                    const buttons = pagination.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.className = '';
                        if (parseInt(button.textContent) === pageNumber) {
                            button.className = 'active';
                        }
                    });
                }

                // Mostrar la primera página
                mostrarPagina(1);
            }

            // Función para cargar promociones
            function cargarPromociones() {
                fetch('/api/obtener_promociones', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al obtener promociones: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Datos recibidos de promociones:', data);
                        if (data.success) {
                            const tbody = document.getElementById("promocionesTableBody");
                            tbody.innerHTML = '';

                            // Verificar si data.data existe y es un array, si no, usar array vacío
                            const promociones = Array.isArray(data.data) ? data.data : [];
                            console.log('Promociones a mostrar:', promociones);

                            promociones.forEach(promocion => {
                                const tr = document.createElement("tr");
                                tr.innerHTML =
                                    `<td><strong>${promocion.nombre}</strong></td>
                                    <td>${formatearFecha(promocion.fecha_inicio)}</td>
                                    <td>${formatearFecha(promocion.fecha_fin)}</td>
                                    <td>${promocion.porcentaje}%</td>
                                    <td>
                                        <button onclick="openEditModal(${promocion.id})">Editar</button>
                                        <button onclick="openVerContenidosModalNuevo(${promocion.id})">Ver Contenidos</button>
                                        <button onclick="openDeleteModal(${promocion.id})">Eliminar</button>
                                    </td>`;
                                tbody.appendChild(tr);
                            });

                            // Agregar estilo para el botón activo de paginación
                            const pagination = document.getElementById('promocionesPagination');
                            pagination.innerHTML += `
                                <style>
                                    /* Estilos para el modal */
                                    .modal {
                                        display: none;
                                        position: fixed;
                                        z-index: 1000;
                                        left: 0;
                                        top: 0;
                                        width: 100%;
                                        height: 100%;
                                        overflow: auto;
                                        background-color: rgba(0,0,0,0.4);
                                    }

                                    .modal-content {
                                        background-color: #fff;
                                        margin: 10% auto;
                                        padding: 20px;
                                        border-radius: 8px;
                                        width: 70%;
                                        max-width: 800px;
                                        position: relative;
                                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                                    }

                                    .modal .close {
                                        position: absolute;
                                        right: 20px;
                                        top: 10px;
                                        font-size: 28px;
                                        font-weight: bold;
                                        cursor: pointer;
                                    }

                                    .modal .table-container {
                                        margin-top: 20px;
                                        flex: 1;
                                        overflow: auto;
                                        width: 100%;
                                    }

                                    .modal .table {
                                        width: 100%;
                                        border-collapse: collapse;
                                        table-layout: fixed;
                                    }

                                    .modal .table th,
                                    .modal .table td {
                                        padding: 12px;
                                        text-align: left;
                                        border-bottom: 1px solid #ddd;
                                        word-wrap: break-word;
                                        min-width: 100px;
                                    }

                                    .modal .table th {
                                        background-color: #f5f5f5;
                                        font-weight: 600;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                    }

                                    .modal .table tr:hover {
                                        background-color: #f9f9f9;
                                    }

                                    /* Asegurar que el modal tenga un tamaño adecuado */
                                    .modal-content {
                                        display: flex;
                                        flex-direction: column;
                                        max-height: 80vh;
                                        min-height: 300px;
                                        width: 90%;
                                        max-width: 1000px;
                                    }

                                    /* Asegurar que la tabla sea desplazable */
                                    .modal .table-wrapper {
                                        flex: 1;
                                        overflow: auto;
                                    }

                                    /* Estilos específicos para las filas de contenidos */
                                    #contenidosPromocionBody tr {
                                        display: table-row !important;
                                        visibility: visible !important;
                                        opacity: 1 !important;
                                        background-color: #fff !important;
                                    }

                                    #contenidosPromocionBody td {
                                        display: table-cell !important;
                                        visibility: visible !important;
                                        opacity: 1 !important;
                                        padding: 12px !important;
                                        border-bottom: 1px solid #ddd !important;
                                    }

                                    /* Estilos para el mensaje de no resultados */
                                    .no-results {
                                        text-align: center !important;
                                        padding: 20px !important;
                                        color: #666 !important;
                                        font-style: italic !important;
                                    }
                                </style>
                            `;

                            paginarTabla('.table', '#promocionesPagination');
                        } else {
                            console.error('Error en la respuesta:', data);
                            alert(data.error || 'Error al cargar las promociones');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al conectar con el servidor: ' + error.message);
                    });
            }

            // Función para formatear fecha (solo fecha, sin hora)
            function formatearFecha(fechaString) {
                if (!fechaString) return '';

                // Si la fecha ya está en formato YYYY-MM-DD, procesarla directamente
                if (/^\d{4}-\d{2}-\d{2}$/.test(fechaString)) {
                    const [year, month, day] = fechaString.split('-');
                    return `${day}/${month}/${year}`;
                }

                // Para otros formatos, usar el método anterior
                try {
                    // Crear la fecha ajustando por la zona horaria
                    const fecha = new Date(fechaString + 'T00:00:00');

                    // Si la fecha no es válida, devolver un valor por defecto
                    if (isNaN(fecha.getTime())) return 'Fecha inválida';

                    // Obtener los componentes de la fecha usando UTC para evitar problemas de zona horaria
                    const dia = fecha.getUTCDate().toString().padStart(2, '0');
                    const mes = (fecha.getUTCMonth() + 1).toString().padStart(2, '0');
                    const anio = fecha.getUTCFullYear();

                    return `${dia}/${mes}/${anio}`;
                } catch (e) {
                    console.error('Error al formatear fecha:', e);
                    return 'Fecha inválida';
                }
            }

            // Función para formatear fecha al formato YYYY-MM-DD (sin hora)
            function formatearFechaParaInput(fechaString) {
                if (!fechaString) return '';

                // Si ya está en el formato YYYY-MM-DD, devolverlo tal cual
                if (/^\d{4}-\d{2}-\d{2}$/.test(fechaString)) {
                    return fechaString;
                }

                try {
                    // Intentar crear una fecha a partir del string
                    const fecha = new Date(fechaString);
                    if (isNaN(fecha.getTime())) {
                        console.error('Fecha inválida:', fechaString);
                        return '';
                    }

                    // Formatear como YYYY-MM-DD usando UTC para evitar problemas de zona horaria
                    const year = fecha.getUTCFullYear();
                    const month = (fecha.getUTCMonth() + 1).toString().padStart(2, '0');
                    const day = fecha.getUTCDate().toString().padStart(2, '0');

                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error('Error al formatear fecha:', e);
                    return '';
                }
            }

            // Función para abrir modal de edición con datos de la promoción
            function openEditarPromocionModal(id, nombre, porcentaje, fechaInicio, fechaFin) {
                document.getElementById('editPromocionId').value = id;
                document.getElementById('editNombrePromocion').value = nombre;
                document.getElementById('editPorcentaje').value = porcentaje;

                // Formatear fechas para el input type="date"
                const fechaInicioObj = new Date(fechaInicio);
                const fechaFinObj = new Date(fechaFin);

                // Formatear a YYYY-MM-DD usando UTC para evitar problemas de zona horaria
                const formatDate = (date) => {
                    const d = new Date(date);
                    // Usar UTC para evitar problemas de zona horaria
                    let month = '' + (d.getUTCMonth() + 1);
                    let day = '' + d.getUTCDate();
                    const year = d.getUTCFullYear();

                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                };

                document.getElementById('editFechaInicio').value = formatDate(fechaInicioObj);
                document.getElementById('editFechaFin').value = formatDate(fechaFinObj);

                // Limpiar tabla de contenidos
                const tbody = document.getElementById('editContenidosPromocionBody');
                tbody.innerHTML = '';

                // Cargar contenidos de la promoción
                fetch(`/api/promociones/${id}/contenidos`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.contenidos && data.contenidos.length > 0) {
                            data.contenidos.forEach(contenido => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${contenido.nombre || 'Sin nombre'}</td>
                                    <td>${contenido.id_contenido || 'N/A'}</td>
                                    <td>${contenido.formato || 'N/A'}</td>
                                    <td>
                                        <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <input type="hidden" name="contenidos[]" value="${contenido.id_contenido}">
                                    </td>`;
                                tbody.appendChild(tr);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar contenidos:', error);
                    });

                openModal('editarPromocionModal');
            }

            function prepararEliminarPromocion(promocionId) {
                if (confirm('¿Está seguro de que desea eliminar esta promoción? Esta acción no se puede deshacer.')) {
                    eliminarPromocion(promocionId);
                }
            }

            async function eliminarPromocion(promocionId) {
                try {
                    const response = await fetch('/api/promociones/eliminar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ promocion_id: promocionId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Promoción eliminada correctamente');
                        cargarPromociones(); // Recargar la lista de promociones
                    } else {
                        throw new Error(data.error || 'Error al eliminar la promoción');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar la promoción: ' + error.message);
                }
            }

            // Función para ver contenidos de una promoción (NUEVA - FUNCIONAL)
            async function openVerContenidosModalNuevo(promocionId) {
                try {
                    console.log('Abriendo NUEVO modal para promoción ID:', promocionId);
                    const response = await fetch(`/api/promociones/${promocionId}/contenidos`);
                    const data = await response.json();

                    console.log('Respuesta completa de la API:', data);

                    if (data.success) {
                        const promocionData = data.data;
                        const contenidos = promocionData.contenidos || [];

                        console.log('Datos de la promoción:', promocionData);
                        console.log('Contenidos encontrados:', contenidos);
                        console.log('Número de contenidos:', contenidos.length);

                        // Actualizar el título del modal
                        document.getElementById('nombrePromocionNuevo').textContent = promocionData.nombre || 'Promoción';

                        // Llenar la tabla de contenidos
                        const tbody = document.getElementById('contenidosPromocionBodyNuevo');
                        tbody.innerHTML = '';

                        if (contenidos.length === 0) {
                            console.log('No hay contenidos, mostrando mensaje');
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666; font-style: italic; border: 1px solid #ddd;">No hay contenidos asociados a esta promoción.</td></tr>';
                        } else {
                            console.log('Agregando contenidos a la tabla...');
                            contenidos.forEach((contenido, index) => {
                                console.log(`Procesando contenido ${index + 1}:`, contenido);
                                const precioOriginal = parseFloat(contenido.precio) || 0;
                                const porcentaje = parseFloat(promocionData.porcentaje) || 0;
                                const precioConDescuento = precioOriginal * (1 - (porcentaje / 100));

                                console.log(`Precio original: ${precioOriginal}, Porcentaje: ${porcentaje}, Precio con descuento: ${precioConDescuento}`);

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td style="border: 1px solid #ddd; padding: 12px;">${contenido.nombre || 'Sin nombre'}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${contenido.codigo || contenido.id || 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">${contenido.formato || 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">S/.${precioOriginal.toFixed(2)}</td>
                                    <td style="border: 1px solid #ddd; padding: 12px;">S/.${precioConDescuento.toFixed(2)}</td>
                                `;
                                console.log('Fila HTML creada:', tr.outerHTML);
                                tbody.appendChild(tr);
                                console.log('Fila agregada al DOM');
                            });
                            console.log('Contenidos agregados a la tabla');
                            console.log('Número total de filas en la tabla:', tbody.children.length);
                        }

                        console.log('Abriendo NUEVO modal...');
                        document.getElementById('modalContenidosNuevo').style.display = 'block';
                        console.log('NUEVO Modal abierto');
                    } else {
                        console.error('Error en la respuesta de la API:', data);
                        alert('Error al cargar los contenidos de la promoción');
                    }
                } catch (error) {
                    console.error('Error en openVerContenidosModalNuevo:', error);
                    alert('Error al cargar los contenidos de la promoción');
                }
            }

            // Función para agregar contenido a promoción nueva
            function agregarContenidoAPromocion() {
                const codigo = document.getElementById("codigoContenido").value.trim();
                if (!codigo) return;

                fetch(`/api/contenido?id=${codigo}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Contenido no encontrado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.contenido) {
                            const contenido = data.contenido;
                            const tbody = document.getElementById("contenidosPromocionBody");

                            // Verificar si el contenido ya está agregado
                            const existente = Array.from(tbody.querySelectorAll("tr")).some(tr => {
                                const codigoCelda = tr.querySelector("td:nth-child(2)").textContent;
                                return codigoCelda === (contenido.codigo || '');
                            });

                            if (existente) {
                                alert("Este contenido ya está incluido en la promoción");
                                return;
                            }

                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                `<td>${contenido.nombre || 'Sin nombre'}</td>
                                <td>${contenido.codigo || 'N/A'}</td>
                                <td>${contenido.formato || 'N/A'}</td>
                                <td>
                                    <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <input type="hidden" name="contenidos[]" value="${contenido.id_contenido || ''}">
                                </td>`;
                            tbody.appendChild(tr);
                            document.getElementById("codigoContenido").value = '';
                        } else {
                            throw new Error(data.error || 'No se encontró contenido con ese ID');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + (error.message || 'No se pudo encontrar el contenido'));
                    });
            }

            // Función para agregar contenido a promoción en edición
            function agregarContenidoAEdicion() {
                const codigo = document.getElementById("editCodigoContenido").value.trim();
                if (!codigo) return;

                fetch(`/api/contenido?id=${codigo}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Contenido no encontrado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.contenido) {
                            const contenido = data.contenido;
                            const tbody = document.getElementById("editContenidosPromocionBody");

                            // Verificar si el contenido ya está agregado
                            const existente = Array.from(tbody.querySelectorAll("tr")).some(tr => {
                                const idContenido = tr.querySelector("input[type='hidden']").value;
                                return idContenido === (contenido.id_contenido || '');
                            });

                            if (existente) {
                                alert("Este contenido ya está incluido en la promoción");
                                return;
                            }

                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                `<td>${contenido.nombre || 'Sin nombre'}</td>
                                <td>${contenido.id_contenido || 'N/A'}</td>
                                <td>${contenido.formato || 'N/A'}</td>
                                <td>
                                    <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <input type="hidden" name="contenidos[]" value="${contenido.id_contenido || ''}">
                                </td>`;
                            tbody.appendChild(tr);
                            document.getElementById("editCodigoContenido").value = '';
                        } else {
                            throw new Error(data.error || 'No se encontró contenido con ese ID');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + (error.message || 'No se pudo encontrar el contenido'));
                    });
            }

            // Función para eliminar contenido de la tabla
            function eliminarContenidoDeTabla(button) {
                const tr = button.closest("tr");
                tr.remove();
            }

            // Búsqueda de promociones
            const searchPromocionInput = document.getElementById('search-promocion');
            searchPromocionInput.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const rows = document.querySelectorAll('#promocionesTableBody tr');

                rows.forEach(fila => {
                    const nombrePromocion = fila.querySelector("td strong").textContent.toLowerCase();

                    if (nombrePromocion.includes(filtro)) {
                        fila.style.display = "";
                    } else {
                        fila.style.display = "none";
                    }
                });
            });

            // Manejo de formulario agregar promoción
            document.getElementById("agregarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                // Obtener IDs de contenidos de la tabla
                const contenidos = [];
                const filasContenidos = document.querySelectorAll('#contenidosPromocionBody tr');
                filasContenidos.forEach(fila => {
                    const idContenido = fila.querySelector('input[type="hidden"]').value;
                    if (idContenido) {
                        contenidos.push(idContenido);
                    }
                });

                // Agregar contenidos al formData
                contenidos.forEach((id, index) => {
                    formData.append('contenidos[]', id);
                });

                try {
                    // Convert FormData to JSON object
                    const formDataObj = {};
                    formData.forEach((value, key) => {
                        if (key === 'contenidos[]') {
                            if (!formDataObj['contenidos']) {
                                formDataObj['contenidos'] = [];
                            }
                            formDataObj['contenidos'].push(value);
                        } else {
                            formDataObj[key] = value;
                        }
                    });

                    // Log the data being sent
                    console.log('Sending data to server:', JSON.stringify(formDataObj, null, 2));

                    try {
                        const response = await fetch('/api/promociones', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formDataObj)
                        });

                        console.log('Response status:', response.status);
                        const responseText = await response.text();
                        console.log('Response text:', responseText);

                        if (!response.ok) {
                            let errorMessage = 'Error al procesar la solicitud';
                            try {
                                const errorData = JSON.parse(responseText);
                                errorMessage = errorData.error || JSON.stringify(errorData);
                            } catch (e) {
                                errorMessage = responseText || errorMessage;
                            }
                            throw new Error(errorMessage);
                        }

                        const data = responseText ? JSON.parse(responseText) : {};

                        if (data.success) {
                            alert('Promoción agregada correctamente');
                            closeModal('agregarPromocionModal');
                            cargarPromociones();
                        } else {
                            throw new Error(data.error || 'Error al agregar la promoción');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert(error.message || 'Error al conectar con el servidor');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                }
            });

            // Manejo de formulario editar promoción
            document.getElementById("editarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();

                const promocionId = document.getElementById("editPromocionId").value;
                const formData = new FormData(this);

                // Obtener todos los contenidos de la tabla
                const contenidos = [];
                document.querySelectorAll('#editContenidosPromocionBody tr').forEach(row => {
                    const input = row.querySelector('input[type="hidden"][name="contenidos[]"]');
                    if (input && input.value) {
                        contenidos.push(input.value);
                    }
                });

                // Agregar cada contenido individualmente al FormData
                contenidos.forEach(contenidoId => {
                    formData.append('contenidos[]', contenidoId);
                });

                try {
                    const response = await fetch(`/api/promociones/${promocionId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Error al actualizar la promoción');
                    }

                    if (result.success) {
                        alert('Promoción actualizada correctamente');
                        closeModal('editarPromocionModal');
                        cargarPromociones();
                    } else {
                        throw new Error(result.error || 'Error al actualizar la promoción');
                    }
                } catch (error) {
                    console.error('Error al actualizar promoción:', error);
                    alert(`Error: ${error.message}`);
                }
            });

            // Manejo de formulario eliminar promoción
            document.getElementById("eliminarPromocionForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                try {
                    const response = await fetch('/api/promociones/eliminar', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Promoción eliminada correctamente');
                        closeModal('eliminarPromocionModal');
                        cargarPromociones();
                    } else {
                        alert(data.error || 'Error al eliminar la promoción');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                }
            });

            // Función para abrir modal
            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "block";
                    // Agregar el overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.onclick = () => closeModal(modalId);
                    document.body.appendChild(overlay);

                    // Solo limpiar el formulario si no es el modal de edición ni el de ver contenidos
                    if (!modalId.includes('editar') && !modalId.includes('verContenidos')) {
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                            // Limpiar la tabla de contenidos solo si no es el modal de ver contenidos
                            const tablaContenidos = modal.querySelector('#contenidosPromocionBody');
                            if (tablaContenidos && !modalId.includes('verContenidos')) {
                                tablaContenidos.innerHTML = '';
                            }
                        }
                    }
                }
            }

            // Función para cerrar modal
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "none";
                    // Remover el overlay
                    const overlay = document.querySelector('.modal-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }
            }

            // Función para abrir modal de eliminar promoción
            function openDeleteModal(promocionId) {
                document.getElementById('promocionIdEliminar').value = promocionId;
                openModal('eliminarPromocionModal');
            }

            // Función para abrir modal de editar promoción
            async function openEditModal(promocionId) {
                try {
                    const response = await fetch(`/api/promociones/${promocionId}`);
                    const data = await response.json();

                    if (data.success) {
                        const promocion = data.data;

                        // Llenar el formulario con los datos de la promoción
                        document.getElementById('editPromocionId').value = promocion.id;
                        document.getElementById('editNombrePromocion').value = promocion.nombre;
                        document.getElementById('editPorcentaje').value = promocion.porcentaje;
                        document.getElementById('editFechaInicio').value = formatearFechaParaInput(promocion.fecha_inicio);
                        document.getElementById('editFechaFin').value = formatearFechaParaInput(promocion.fecha_fin);

                        // Limpiar tabla de contenidos
                        const tbody = document.getElementById('editContenidosPromocionBody');
                        tbody.innerHTML = '';

                        // Cargar contenidos de la promoción si existen
                        if (promocion.contenidos && promocion.contenidos.length > 0) {
                            promocion.contenidos.forEach(contenido => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${contenido.nombre || 'Sin nombre'}</td>
                                    <td>${contenido.codigo || contenido.id_contenido || 'N/A'}</td>
                                    <td>${contenido.formato || 'N/A'}</td>
                                    <td>
                                        <input type="hidden" name="contenidos[]" value="${contenido.id_contenido}">
                                        <button type="button" class="button-icon deletebtn" onclick="eliminarContenidoDeTabla(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });
                        }

                        openModal('editarPromocionModal');
                    } else {
                        alert('Error al cargar los datos de la promoción');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al cargar los datos de la promoción');
                }
            }

            // Cargar promociones al iniciar
            document.addEventListener('DOMContentLoaded', function() {
                cargarPromociones();
            });
        </script>
    </div>
</div>
</body>
</html>