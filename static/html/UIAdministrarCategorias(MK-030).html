<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Categorías - QCM</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>QCM Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="UIInicioAdmin.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="#" class="nav-link active">
                    <i class="fas fa-tags"></i>
                    <span>Administrar Categorías</span>
                </a>
                <a href="UIAdministrarContenidos(MK-034).html" class="nav-link">
                    <i class="fas fa-file-alt"></i>
                    <span>Administrar Contenidos</span>
                </a>
                <a href="UIAdministrarCliente(MK-038).html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Administrar Clientes</span>
                </a>
                <a href="UIAdministrarPromocion(MK-025).html" class="nav-link">
                    <i class="fas fa-percentage"></i>
                    <span>Administrar Promociones</span>
                </a>
                <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </nav>
        </div>
        
        <div class="main-content">
            <h1>Administrar Categorías</h1>
            
            <div class="admin-actions">
                <button onclick="mostrarFormularioCategoria()" class="btn btn-primary">Agregar Nueva Categoría</button>
            </div>
            
            <div class="categorias-container">
                <div class="categorias-principales">
                    <h3>Categorías Principales</h3>
                    <div id="categorias-principales-lista"></div>
                </div>
                
                <div class="subcategorias">
                    <h3>Subcategorías</h3>
                    <div id="subcategorias-lista"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            cargarCategorias();
        });

        function cargarCategorias() {
            fetch('/api/categorias')
                .then(response => response.json())
                .then(data => {
                    const categoriasPrincipales = data.filter(cat => !cat.id_categoria_padre);
                    const subcategorias = data.filter(cat => cat.id_categoria_padre);
                    
                    mostrarCategoriasPrincipales(categoriasPrincipales);
                    mostrarSubcategorias(subcategorias, data);
                })
                .catch(error => console.error('Error:', error));
        }

        function mostrarCategoriasPrincipales(categorias) {
            const lista = document.getElementById('categorias-principales-lista');
            lista.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${categorias.map(cat => `
                            <tr>
                                <td>${cat.id_categoria}</td>
                                <td>${cat.nombre}</td>
                                <td>${cat.descripcion || 'Sin descripción'}</td>
                                <td>
                                    <button onclick="editarCategoria(${cat.id_categoria})" class="btn btn-small">Editar</button>
                                    <button onclick="eliminarCategoria(${cat.id_categoria})" class="btn btn-small btn-danger">Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function mostrarSubcategorias(subcategorias, todasCategorias) {
            const lista = document.getElementById('subcategorias-lista');
            lista.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Categoría Padre</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subcategorias.map(sub => {
                            const categoriaPadre = todasCategorias.find(cat => cat.id_categoria === sub.id_categoria_padre);
                            return `
                                <tr>
                                    <td>${sub.id_categoria}</td>
                                    <td>${sub.nombre}</td>
                                    <td>${categoriaPadre ? categoriaPadre.nombre : 'N/A'}</td>
                                    <td>${sub.descripcion || 'Sin descripción'}</td>
                                    <td>
                                        <button onclick="editarCategoria(${sub.id_categoria})" class="btn btn-small">Editar</button>
                                        <button onclick="eliminarCategoria(${sub.id_categoria})" class="btn btn-small btn-danger">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function mostrarFormularioCategoria() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Agregar Nueva Categoría</h3>
                    <form id="form-categoria">
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Descripción:</label>
                            <textarea name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Categoría:</label>
                            <select name="tipo_categoria" onchange="toggleCategoriaPadre(this.value)">
                                <option value="principal">Categoría Principal</option>
                                <option value="subcategoria">Subcategoría</option>
                            </select>
                        </div>
                        <div class="form-group" id="categoria-padre-group" style="display: none;">
                            <label>Categoría Padre:</label>
                            <select name="id_categoria_padre">
                                <option value="">Seleccionar categoría padre</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" onclick="cerrarModal()" class="btn">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            cargarCategoriasPrincipalesParaSelect();
            
            document.getElementById('form-categoria').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion'),
                    id_categoria_padre: formData.get('tipo_categoria') === 'subcategoria' ? 
                        formData.get('id_categoria_padre') : null
                };
                
                fetch('/api/categorias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        cerrarModal();
                        cargarCategorias();
                        alert('Categoría agregada exitosamente');
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al agregar la categoría');
                });
            });
        }

        function toggleCategoriaPadre(tipo) {
            const grupo = document.getElementById('categoria-padre-group');
            if (tipo === 'subcategoria') {
                grupo.style.display = 'block';
            } else {
                grupo.style.display = 'none';
            }
        }

        function cargarCategoriasPrincipalesParaSelect() {
            fetch('/api/categorias')
                .then(response => response.json())
                .then(data => {
                    const categoriasPrincipales = data.filter(cat => !cat.id_categoria_padre);
                    const select = document.querySelector('select[name="id_categoria_padre"]');
                    
                    categoriasPrincipales.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id_categoria;
                        option.textContent = cat.nombre;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function editarCategoria(id) {
            fetch(`/api/categorias/${id}`)
                .then(response => response.json())
                .then(categoria => {
                    mostrarFormularioEditarCategoria(categoria);
                })
                .catch(error => console.error('Error:', error));
        }

        function mostrarFormularioEditarCategoria(categoria) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Editar Categoría</h3>
                    <form id="form-editar-categoria">
                        <input type="hidden" name="id_categoria" value="${categoria.id_categoria}">
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" name="nombre" value="${categoria.nombre}" required>
                        </div>
                        <div class="form-group">
                            <label>Descripción:</label>
                            <textarea name="descripcion" rows="3">${categoria.descripcion || ''}</textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Actualizar</button>
                            <button type="button" onclick="cerrarModal()" class="btn">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('form-editar-categoria').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion')
                };
                
                fetch(`/api/categorias/${categoria.id_categoria}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        cerrarModal();
                        cargarCategorias();
                        alert('Categoría actualizada exitosamente');
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al actualizar la categoría');
                });
            });
        }

        function eliminarCategoria(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría? Esta acción no se puede deshacer.')) {
                fetch(`/api/categorias/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            cargarCategorias();
                            alert('Categoría eliminada exitosamente');
                        } else {
                            alert('Error: ' + result.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al eliminar la categoría');
                    });
            }
        }

        function cerrarModal() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = 'UIAccesoAlPortal(MK-001).html';
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>