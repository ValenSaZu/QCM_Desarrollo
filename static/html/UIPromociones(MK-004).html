<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Promociones - QuickContentMedia</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .promotion-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 2;
        }

        .discount-price {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 1.2em;
        }

        .original-price {
            text-decoration: line-through;
            color: #666;
            font-size: 0.9em;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="side-bar">
            <div class="name">QCM</div>
            <div class="side-bar-options">
                <a href="/cliente"><i class="fa-solid fa-house"></i><span>Inicio</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/cliente/carrito"><i class="fa-solid fa-cart-shopping"></i><span>Carrito</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/ofertas" class="active"><i class="fa-solid fa-percent"></i><span>Ofertas</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/cliente/ranking"><i class="fa-solid fa-trophy"></i><span>Ranking</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/cliente/mis-contenidos"><i class="fa-solid fa-folder-open"></i><span>Mis Contenidos</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/cliente/perfil"><i class="fa-solid fa-user"></i><span>Perfil</span></a>
            </div>
            <div class="side-bar-options">
                <a href="/logout" id="logout-link"><i class="fa-solid fa-right-from-bracket"></i><span>Cerrar Sesión</span></a>
            </div>
        </div>

        <div class="main-content">
            <div class="content-wrapper">
                <div class="content-header">
                    <h2 class="page-title">Contenidos en Promoción</h2>
                    <div class="search-container">
                        <input type="text" id="search-content" class="search-input" placeholder="Buscar por autor o categoría...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>

                <div class="content-layout">
                    <div class="content-column">
                        <div class="column-header">
                            <i class="fas fa-video"></i>
                            <h3>Videos</h3>
                        </div>
                        <div class="content-cards" id="videos-container"></div>
                    </div>
                    <div class="content-column">
                        <div class="column-header">
                            <i class="fas fa-image"></i>
                            <h3>Imágenes</h3>
                        </div>
                        <div class="content-cards" id="images-container"></div>
                    </div>
                    <div class="content-column">
                        <div class="column-header">
                            <i class="fas fa-music"></i>
                            <h3>Audios</h3>
                        </div>
                        <div class="content-cards" id="audios-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="contentDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeContentModal">&times;</span>
            <div class="modal-grid">
                <div class="left-grid">
                    <div id="contentPreview" class="preview-area"></div>
                </div>
                <div class="right-grid">
                    <h2 id="contentTitle" class="small-title"></h2>
                    <p id="contentAuthor" class="content-meta"><i class="fas fa-user"></i> <span></span></p>
                    <p id="contentCategory" class="content-meta"><i class="fas fa-tag"></i> <span></span></p>
                    <div class="rating-container">
                        <div id="contentRating" class="rating"></div>
                        <span id="ratingValue" class="rating-text"></span>
                    </div>
                    <p id="contentDescription" class="content-description"></p>
                    <div class="file-info">
                        <div class="file-box" id="contentSize">Peso: -</div>
                        <div class="file-box" id="contentExtension">Extensión: -</div>
                        <div class="file-box" id="contentMime">MIME-Type: -</div>
                    </div>
                    <div class="price-container">
                        <span id="contentPrice" class="price"></span>
                        <span id="contentDiscountPrice" class="discount-price"></span>
                    </div>
                    <button id="addToCartBtn" class="button-full">
                        <i class="fas fa-cart-plus"></i> Añadir al carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar sesión
        fetch('/api/sesion', {
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                window.location.href = '/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                window.location.href = '/login';
            }
            // Cargar contenidos
            cargarContenidosPromocion();
            // Manejar cierre de sesión
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(() => {
                    window.location.href = '/';
                });
            });
        })
        .catch(error => {
            console.error('Error al cargar la sesión:', error);
            window.location.href = '/login';
        });
    });

        let allContents = [];
        let currentContent = null;
        const searchInput = document.getElementById('search-content');
        const videosContainer = document.getElementById('videos-container');
        const imagesContainer = document.getElementById('images-container');
        const audiosContainer = document.getElementById('audios-container');
        const contentDetailModal = document.getElementById('contentDetailModal');
        const closeContentModal = document.getElementById('closeContentModal');
        const addToCartBtn = document.getElementById('addToCartBtn');
    const modalOverlay = document.getElementById('modalOverlay');

    async function cargarContenidosPromocion() {
            try {
                const response = await fetch('/api/promociones/contenidos');
            if (!response.ok) throw new Error('Error al cargar contenidos en promoción');
                const result = await response.json();
            allContents = Array.isArray(result) ? result : (result.success ? result.data : []);
                actualizarContenidos(allContents);
            } catch (error) {
            videosContainer.innerHTML = imagesContainer.innerHTML = audiosContainer.innerHTML = '<div class="no-content">No se encontraron contenidos en promoción</div>';
        }
    }

        function actualizarContenidos(contenidos) {
            videosContainer.innerHTML = '';
            imagesContainer.innerHTML = '';
            audiosContainer.innerHTML = '';
            if (!Array.isArray(contenidos) || contenidos.length === 0) {
            const noContentMsg = '<div class="no-content">No se encontraron contenidos en promoción</div>';
            videosContainer.innerHTML = imagesContainer.innerHTML = audiosContainer.innerHTML = noContentMsg;
                return;
            }
        const videos = contenidos.filter(c => c.tipo_contenido === 'video');
        const imagenes = contenidos.filter(c => c.tipo_contenido === 'imagen');
        const audios = contenidos.filter(c => c.tipo_contenido === 'audio');
        if (videos.length > 0) videos.forEach(video => videosContainer.appendChild(crearTarjetaContenido(video)));
        else videosContainer.innerHTML = '<div class="no-content">No hay videos en promoción</div>';
        if (imagenes.length > 0) imagenes.forEach(imagen => imagesContainer.appendChild(crearTarjetaContenido(imagen)));
        else imagesContainer.innerHTML = '<div class="no-content">No hay imágenes en promoción</div>';
        if (audios.length > 0) audios.forEach(audio => audiosContainer.appendChild(crearTarjetaContenido(audio)));
        else audiosContainer.innerHTML = '<div class="no-content">No hay audios en promoción</div>';
    }

        function crearTarjetaContenido(contenido) {
            if (!contenido) return null;

            const card = document.createElement('div');
            card.className = 'content-card';
            card.dataset.id = contenido.id_contenido;
        card.dataset.type = contenido.tipo_contenido;
        card.dataset.author = contenido.autor?.toLowerCase() || '';
        card.dataset.category = contenido.categoria?.toLowerCase() || '';

        const preview = document.createElement('div');
        preview.className = 'content-thumbnail';
        const img = document.createElement('img');
        img.src = contenido.miniatura_url || '/placeholder-image.jpg';
        img.alt = contenido.nombre || 'miniatura';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        img.onerror = function() {
            this.style.display = 'none';
            const fallback = document.createElement('div');
            fallback.style.display = 'flex';
            fallback.style.alignItems = 'center';
            fallback.style.justifyContent = 'center';
            fallback.style.height = '100%';
            fallback.innerHTML = "<i class='fas fa-image' style='font-size:2em;color:#ccc;'></i>";
            this.parentNode.appendChild(fallback);
        };
        preview.appendChild(img);
        
        const overlay = document.createElement('div');
        overlay.className = 'content-overlay';
        const viewBtn = document.createElement('button');
        viewBtn.className = 'view-content-btn';
        viewBtn.dataset.id = contenido.id_contenido;
        viewBtn.innerHTML = '<i class="fas fa-eye"></i> Ver';
        overlay.appendChild(viewBtn);
        preview.appendChild(overlay);

        const info = document.createElement('div');
        info.className = 'content-info';
        info.innerHTML = `
                    <h4 class="content-title">${contenido.nombre || 'Sin título'}</h4>
                    <div class="content-meta" style="margin: 8px 0;">
                        <i class="fas fa-user" style="color: #666; margin-right: 5px;"></i>
                        <span style="color: #333; font-weight: 500;">${contenido.autor || 'Autor desconocido'}</span>
                    </div>
                    <div class="content-meta" style="margin: 8px 0;">
                        <i class="fas fa-tag" style="color: #666; margin-right: 5px;"></i>
                        <span style="color: #333;">${contenido.categoria || 'Sin categoría'}</span>
                    </div>
                    <div class="rating-container" style="margin: 12px 0; display: flex; align-items: center; gap: 8px;">
                        <div class="rating-stars" style="display: flex; gap: 2px;">
                    ${crearEstrellasCalificacion(contenido.calificacion || 0)}
                        </div>
                <span style="color: #666; font-size: 0.9em; font-weight: 500;">${(contenido.calificacion || 0).toFixed(1)}/10</span>
                    </div>
        `;
        const priceContainer = document.createElement('div');
        priceContainer.className = 'price-container';
        priceContainer.style.marginTop = '12px';
        priceContainer.style.padding = '10px';
        priceContainer.style.background = 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
        priceContainer.style.borderRadius = '8px';
        priceContainer.style.border = '1px solid #dee2e6';
        priceContainer.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="color: #666; font-size: 0.9em;">Precio original:</span>
                <span class="original-price" style="text-decoration: line-through; color: #999; font-size: 1em;">S/.${(contenido.precio_original || 0).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #28a745; font-weight: bold; font-size: 0.9em;">Precio con descuento:</span>
                <span class="discount-price" style="color: #ff6b6b; font-weight: bold; font-size: 1.2em;">S/.${(contenido.precio_descuento || contenido.precio_original || 0).toFixed(2)}${contenido.porcentaje_descuento > 0 ? ` <span style='font-size:0.9em; color:#ff6b6b;'>(-${contenido.porcentaje_descuento}% OFF)</span>` : ''}</span>
                        </div>
                        <div style="text-align: center; margin-top: 5px;">
                            <span style="background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                    ¡Ahorras S/.${((contenido.precio_original || 0) - (contenido.precio_descuento || 0)).toFixed(2)}!
                            </span>
                </div>
            `;
        info.appendChild(priceContainer);

        card.appendChild(preview);
        card.appendChild(info);

                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mostrarDetallesContenido(contenido);
                });

            return card;
        }

        function crearEstrellasCalificacion(calificacion) {
            let html = '';
            
            for (let i = 1; i <= 10; i++) {
                if (i <= calificacion) {
                    html += '<span style="color: #ffc107; font-size: 14px; margin-right: 1px;">★</span>';
                } else if (i - 0.5 <= calificacion) {
                    html += '<span style="color: #ffc107; font-size: 14px; margin-right: 1px;">☆</span>';
                } else {
                    html += '<span style="color: #ddd; font-size: 14px; margin-right: 1px;">☆</span>';
                }
            }
            
            return html;
        }

        function mostrarDetallesContenido(contenido) {
            currentContent = contenido;
            document.getElementById('contentTitle').textContent = contenido.nombre || 'Sin título';
            document.getElementById('contentAuthor').querySelector('span').textContent = contenido.autor || 'Autor desconocido';
            document.getElementById('contentCategory').querySelector('span').textContent = contenido.categoria || 'Sin categoría';
            document.getElementById('contentDescription').textContent = contenido.descripcion || 'Sin descripción';
            const ratingContainer = document.getElementById('contentRating');
            ratingContainer.innerHTML = crearEstrellasCalificacion(contenido.calificacion || 0);
            document.getElementById('ratingValue').textContent = `${contenido.calificacion || 0}/10`;
            document.getElementById('contentSize').textContent = `Peso: ${formatearTamano(contenido.tamano)}`;
            document.getElementById('contentExtension').textContent = `Extensión: ${contenido.formato || 'Desconocido'}`;
            document.getElementById('contentMime').textContent = `MIME-Type: ${obtenerMimeType(contenido.formato)}`;
        const precioOriginal = contenido.precio_original || 0;
        const descuento = contenido.porcentaje_descuento || 0;
        const precioConDescuento = contenido.precio_descuento || precioOriginal;
            let preciosHTML = '';
            if (descuento > 0) {
                preciosHTML = `
                    <div style="background: linear-gradient(135deg, #fff5f5, #ffe8e8); border: 2px solid #ff6b6b; border-radius: 12px; padding: 15px; margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #666; font-size: 1em; font-weight: 500;">Precio original:</span>
                            <span style="text-decoration: line-through; color: #999; font-size: 1.1em; font-weight: 500;">S/.${precioOriginal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #28a745; font-weight: bold; font-size: 1em;">Precio con descuento:</span>
                            <span style="color: #ff6b6b; font-weight: bold; font-size: 1.4em;">S/.${precioConDescuento.toFixed(2)}</span>
                        </div>
                    <div style="text-align: center; margin-top: 5px;">
                        <span style="background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                            ¡Ahorras S/.${(precioOriginal - precioConDescuento).toFixed(2)}!
                        </span>
                    </div>
                    </div>
                `;
            } else {
            preciosHTML = `<div style="margin: 15px 0; font-size: 1.2em; color: #333; font-weight: bold;">S/.${precioOriginal.toFixed(2)}</div>`;
        }
        document.getElementById('contentPrice').innerHTML = preciosHTML;
        modalOverlay.style.display = 'block';
        contentDetailModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function cerrarModal() {
        modalOverlay.style.display = 'none';
        contentDetailModal.style.display = 'none';
        document.body.style.overflow = '';
    }

        function formatearTamano(bytes) {
            if (!bytes) return 'Desconocido';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function obtenerMimeType(formato) {
            if (!formato) return 'application/octet-stream';
            
            const mimeTypes = {
                'mp4': 'video/mp4', 'avi': 'video/x-msvideo', 'mov': 'video/quicktime',
                'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png', 'gif': 'image/gif',
                'mp3': 'audio/mpeg', 'wav': 'audio/wav', 'ogg': 'audio/ogg'
            };
            
            return mimeTypes[formato.toLowerCase()] || 'application/octet-stream';
        }

    closeContentModal.addEventListener('click', cerrarModal);
    modalOverlay.addEventListener('click', cerrarModal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && contentDetailModal.style.display === 'block') {
            cerrarModal();
        }
    });

        addToCartBtn.addEventListener('click', async () => {
            if (!currentContent) return;

            try {
                const response = await fetch('/api/carrito/agregar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_contenido: currentContent.id_contenido,
                        cantidad: 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('¡Contenido añadido al carrito!');
                    contentDetailModal.style.display = 'none';
                } else {
                    showError(result.error || 'Error al añadir al carrito');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al añadir al carrito');
            }
        });

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredContents = allContents.filter(contenido => 
                contenido.nombre?.toLowerCase().includes(searchTerm) ||
                contenido.autor?.toLowerCase().includes(searchTerm) ||
                contenido.categoria?.toLowerCase().includes(searchTerm)
            );
            actualizarContenidos(filteredContents);
        });

        function showLoader() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        loader.style.zIndex = '100';
        document.body.style.overflow = 'hidden';
        }

        function hideLoader() {
        const loader = document.getElementById('loader');
        loader.style.display = 'none';
        loader.style.zIndex = '100';
        document.body.style.overflow = '';
        }

        function showSuccess(message) {
        alert(message);
        }

        function showError(message) {
        alert('Error: ' + message);
        }
    </script>
</body>
</html> 